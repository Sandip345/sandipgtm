---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allProjects = await getCollection('projects');

/**
 * Convert a project's date/period string into a sortable timestamp.
 * Supports:
 *  - date: "2024-08-15", "2024-08", "2024"
 *  - date: "Aug 2024", "August 2024"
 *  - period: "2020", "2020-2021", "2020–2021", "Fall 2023"
 * If nothing usable, returns 0 (goes last).
 */
const toSortableTime = (p) => {
  const raw = (p.data.date ?? p.data.period ?? '').toString().trim();
  if (!raw) return 0;

  // 1) ISO-like: YYYY, YYYY-MM, YYYY-MM-DD
  const iso = raw.match(/^(\d{4})(?:-(\d{2}))?(?:-(\d{2}))?/);
  if (iso) {
    const y = Number(iso[1]);
    const m = Number(iso[2] ?? '01');
    const d = Number(iso[3] ?? '01');
    return new Date(y, m - 1, d).getTime();
  }

  // 2) Month name + year: "Aug 2024", "August 2024"
  const my = raw.match(
    /(jan|feb|mar|apr|may|jun|jul|aug|sep|sept|oct|nov|dec)[a-z]*\s+(\d{4})/i
  );
  if (my) {
    const key = my[1].slice(0, 3).toLowerCase();
    const months = {
      jan: 1, feb: 2, mar: 3, apr: 4, may: 5, jun: 6,
      jul: 7, aug: 8, sep: 9, oct: 10, nov: 11, dec: 12,
    };
    const mon = months[key] ?? 1;
    const y = Number(my[2]);
    return new Date(y, mon - 1, 1).getTime();
  }

  // 3) Year range like "2020-2021" or "2020–2021" -> use END year as "latest"
  const range = raw.match(/(\d{4})\s*[-–—]\s*(\d{4})/);
  if (range) {
    const endYear = Number(range[2]);
    return new Date(endYear, 0, 1).getTime();
  }

  // 4) Any single year anywhere (e.g., "Fall 2023", "2020")
  const yOnly = raw.match(/(\d{4})/);
  if (yOnly) {
    const y = Number(yOnly[1]);
    return new Date(y, 0, 1).getTime();
  }

  return 0;
};

// Sort latest first
const projects = allProjects
  .slice()
  .sort((a, b) => toSortableTime(b) - toSortableTime(a));
---

<BaseLayout title="Projects" description="All projects">
  <div class="mb-8 space-y-2">
    <h1 class="text-3xl font-semibold tracking-tight dark:text-emerald-300">
      Projects
    </h1>

    <p class="t-muted text-sm">
      Selected work and engineering projects.
    </p>

    <div class="t-mono t-meta text-xs">
      $ ls -la projects/ <span class="cursor-blink ml-1">|</span>
    </div>
  </div>

  <!-- Full-width stacked list -->
  <div class="space-y-6">
    {projects.map((p) => (
      <a
        href={`/projects/${p.slug}`}
        class="t-card group block overflow-hidden transition hover:-translate-y-0.5"
      >
        <div class="grid md:grid-cols-[340px_1fr]">
          {/* Left cover image (optional) */}
          {p.data.coverImage ? (
            <div class="relative h-72 overflow-hidden md:h-full">
              <img
                src={p.data.coverImage}
                alt={p.data.title}
                class="absolute inset-0 h-full w-full object-cover transition duration-300 group-hover:scale-105"
                loading="lazy"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-black/30 via-transparent to-transparent opacity-70 group-hover:opacity-50" />
            </div>
          ) : (
            <div class="h-72 bg-slate-100 md:h-full dark:bg-white/5" />
          )}

          {/* Right content */}
          <div class="p-5 md:p-7">
            <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
              <div class="t-mono text-xs text-slate-500 dark:text-[#d7fbe7]/60">
              {p.data.date ?? p.data.period ?? 'Project'}
            </div>



              {p.data.company ? (
                <>
                  <span class="text-slate-300 dark:text-white/20">•</span>
                  <div class="t-meta text-xs">
                    <span class="t-mono font-semibold text-slate-800 dark:text-[#d7fbe7]">
                      {p.data.company}
                    </span>
                  </div>
                </>
              ) : null}
            </div>

            <h2 class="mt-2 text-xl font-semibold text-slate-900 dark:text-[#d7fbe7] group-hover:underline">
              {p.data.title}
            </h2>

            <p class="t-muted mt-2 text-sm leading-relaxed line-clamp-6">
            {p.data.description ?? 'Open to read details.'}
          </p>


            {p.data.tags?.length ? (
              <div class="mt-4 flex flex-wrap gap-2">
                {p.data.tags.slice(0, 6).map((t) => (
                  <span class="t-badge t-mono">{t}</span>
                ))}
              </div>
            ) : null}

            <div class="mt-6 t-mono text-xs font-semibold text-slate-700 dark:text-emerald-300/90">
              $ open ./projects/{p.slug}{' '}
              <span class="inline-block transition group-hover:translate-x-0.5">→</span>
            </div>
          </div>
        </div>
      </a>
    ))}
  </div>
</BaseLayout>
