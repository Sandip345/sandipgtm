---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const experiences = (await getCollection('experience')).sort((a, b) =>
  (b.data.start ?? '').localeCompare(a.data.start ?? '')
);

// render markdown bodies for all experiences
const rendered = await Promise.all(
  experiences.map(async (e) => {
    const { Content } = await e.render();
    return { e, Content };
  })
);
---

<BaseLayout title="Experience" description="Work and research experience">
  <div class="mb-8 space-y-2">
    <h1 class="text-3xl font-semibold tracking-tight dark:text-emerald-300">
      Experience
    </h1>

    <p class="t-muted text-sm">
      Markdown-driven entries from{' '}
      <code class="t-mono rounded bg-slate-100 px-1 dark:bg-white/5">
        src/content/experience
      </code>.
    </p>

    <div class="t-mono t-meta text-xs">
      $ cat ./experience/* <span class="cursor-blink ml-1">|</span>
    </div>
  </div>

  <!-- Big stacked cards (NOT clickable) -->
  <div class="space-y-6">
    {rendered.map(({ e, Content }) => (
      <article class="t-card p-6 md:p-8">
        <div class="flex flex-wrap items-center gap-x-3 gap-y-1">
          <div class="t-mono t-meta text-xs">
            {(e.data.start ?? '')}{e.data.end ? ` - ${e.data.end}` : ' - Present'}
          </div>

          <span class="text-slate-300 dark:text-white/20">•</span>

          <div class="t-meta text-xs">
            <span class="t-mono font-semibold text-slate-800 dark:text-[#d7fbe7]">
              {e.data.company}
            </span>
            {e.data.location ? ` — ${e.data.location}` : ''}
          </div>
        </div>

        <h2 class="mt-3 text-xl font-semibold text-slate-900 dark:text-[#d7fbe7]">
          {e.data.title}
        </h2>

        {e.data.summary ? (
          <p class="t-muted mt-2 text-sm leading-relaxed">
            {e.data.summary}
          </p>
        ) : null}

        {e.data.tags?.length ? (
          <div class="mt-4 flex flex-wrap gap-2">
            {e.data.tags.map((t) => (
              <span class="t-badge t-mono">{t}</span>
            ))}
          </div>
        ) : null}

        {/* Optional: collapse long details (remove <details> wrapper if you want always-open) */}
        <details class="mt-6">
          <summary class="t-mono t-meta cursor-pointer select-none text-xs hover:text-slate-900 dark:hover:text-emerald-300">
            VIEW DETAILS
          </summary>

          <div class="prose prose-slate mt-4 max-w-none dark:prose-invert">
            <Content />
          </div>
        </details>
      </article>
    ))}
  </div>

  <style>
    /* Make <details> summary look nice */
    :global(details > summary) {
      list-style: none;
    }
    :global(details > summary::-webkit-details-marker) {
      display: none;
    }

    /* Prose readability tweaks (match projects/slug styling) */
    :global(.dark .prose) {
      color: rgba(215, 251, 231, 0.86);
    }
    :global(.dark .prose strong) {
      color: rgba(215, 251, 231, 0.95);
    }
    :global(.dark .prose a) {
      color: rgba(110, 231, 183, 0.95);
      text-decoration: none;
    }
    :global(.dark .prose a:hover) {
      text-decoration: underline;
    }
    :global(.dark .prose code) {
      color: rgba(134, 239, 172, 0.95);
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.10);
      padding: 0.15rem 0.35rem;
      border-radius: 0.5rem;
    }
    :global(.dark .prose pre) {
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.10);
    }
    :global(.dark .prose hr) {
      border-color: rgba(255, 255, 255, 0.10);
    }
    :global(.dark .prose blockquote) {
      border-left-color: rgba(34, 197, 94, 0.35);
    }
  </style>
</BaseLayout>
